# ==============================================================================
# Laravel Nginx TCP — конфигурация виртуального хоста для Laravel
# ==============================================================================
# Назначение:
# - Отдаёт статические файлы Laravel (публичные ассеты)
# - Проксирует запросы к PHP-файлам в PHP-FPM через FastCGI по TCP (порт 9000)
# - Обрабатывает маршрутизацию Laravel через index.php
# - Защищает от доступа к служебным файлам (.git, .env и т.д.)
#
# Архитектура:
# - Nginx слушает порт 80, доступен на http://localhost
# - PHP-FPM слушает TCP-порт 9000 внутри Docker-сети (имя сервиса: laravel-php-nginx-tcp)
# - Корневая директория (DocumentRoot): /var/www/laravel/public
# ==============================================================================

server {
    # Прослушиваем порт 80 (HTTP)
    listen       80;
    server_name  localhost;

    # Корневая директория сайта (DocumentRoot для Laravel)
    # Должна указывать на папку public внутри проекта
    root   /var/www/laravel/public;

    # Индексные файлы: приоритет отдаётся index.php
    index  index.php;

    server_tokens off;            # Скрываем версию nginx и Server заголовок

    # Логирование (Docker-friendly)
    error_log  /dev/stderr warn;
    access_log /dev/stdout;

    # --------------------------------------------------------------------------
    # Обработка статических файлов и маршрутизация Laravel
    # --------------------------------------------------------------------------
    # Если запрошен файл или директория — отдаём напрямую.
    # Если не найдено — перенаправляем на index.php с сохранением строки запроса.
    # Это необходимо для работы системы роутинга Laravel.
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # --------------------------------------------------------------------------
    # Оптимизация логов для системных файлов
    # --------------------------------------------------------------------------
    # Не записываем в логи запросы к favicon.ico и robots.txt, чтобы не забивать их
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # --------------------------------------------------------------------------
    # Обработка PHP-скриптов через FastCGI (TCP-соединение с PHP-FPM)
    # --------------------------------------------------------------------------
    # Все запросы к файлам с расширением .php проксируются в контейнер PHP-FPM.
    location ~ \.php$ {
        # Проверяем существование файла, иначе возвращаем 404
        try_files $uri =404;

        # Подключаем стандартный набор FastCGI-параметров
        # Используем абсолютный путь к конфигу внутри контейнера Nginx
        include /etc/nginx/fastcgi_params;

        # Адрес PHP-FPM: имя сервиса из docker-compose.yml и порт 9000
        fastcgi_pass   laravel-php-nginx-tcp:9000;

        # Индексный файл для FastCGI
        fastcgi_index  index.php;

        # --------------------------------------------------------------------------
        # Критически важные параметры для корректной работы PHP
        # --------------------------------------------------------------------------
        # SCRIPT_FILENAME — полный путь к исполняемому PHP-файлу в контейнере PHP
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;

        # DOCUMENT_ROOT — корневая директория сайта для PHP
        fastcgi_param  DOCUMENT_ROOT  $document_root;

        # Гигиена заголовков. Скрывает информацию о серверных технологиях
        fastcgi_hide_header X-Powered-By;

        # --------------------------------------------------------------------------
        # Буферы для FastCGI
        # --------------------------------------------------------------------------
        # Буферы (иногда спасают при больших заголовках/ответах)
        fastcgi_buffer_size 128k;
        fastcgi_buffers 4 256k;
        fastcgi_busy_buffers_size 256k;

        # --------------------------------------------------------------------------
        # Таймауты для комфортной разработки и отладки
        # --------------------------------------------------------------------------
        # Увеличенный таймаут ожидания ответа от PHP-FPM (полезно при дебаге)
        # Таймауты для взаимодействия с PHP-FPM
        # Важно при предотвращении зависаний при медленной работе
        fastcgi_connect_timeout 5s;     # Таймаут на установку соединения с PHP-FPM
        fastcgi_send_timeout 30s;       # Таймаут на отправку данных в PHP-FPM
        fastcgi_read_timeout 30s;       # Таймаут на чтение данных от PHP-FPM

    }

    # --------------------------------------------------------------------------
    # Безопасность: запрет доступа к скрытым файлам
    # --------------------------------------------------------------------------
    # Блокируем доступ к файлам, начинающимся с точки (.env, .git и т.д.)
    # Исключение сделано для .well-known (используется для Let's Encrypt)
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # --------------------------------------------------------------------------
    # Ограничение размера загружаемых файлов
    # --------------------------------------------------------------------------
    # Согласовано с настройками PHP в php.ini
    client_max_body_size 20M;
}
