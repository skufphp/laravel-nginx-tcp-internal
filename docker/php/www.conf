; ==============================================================================
; КОНФИГУРАЦИЯ ПУЛА PHP-FPM (www)
; Особенности:
;   - Работа по TCP-порту внутри контейнерной сети (удобно для связки с Nginx в Docker)
;   - Прокидывание переменных окружения внутрь PHP (для .env / Xdebug / конфигов)
;   - Встроенный healthcheck через ping endpoint (/ping -> "pong")
; ==============================================================================

; Название пула процессов.
; Используется в логах/статусе, а также полезно при наличии нескольких пулов.
[www]

; Адрес, на котором FPM принимает FastCGI-запросы.
; Здесь выбран TCP-порт 9000 (частый вариант для Docker):
; - проще подключать Nginx по сети (container-to-container)
; - не нужно шарить файловую систему под UNIX-сокет
; Минус: TCP чуть «тяжелее», чем UNIX-сокет, но в одной docker-сети обычно это не критично.
listen = 9000

; Пользователь и группа, от имени которых будут выполняться PHP-скрипты.
; Важно: права на storage/, bootstrap/cache/ и прочие writable-директории должны это учитывать.
user = www-data
group = www-data

; Прокидывать переменные окружения внутрь PHP.
; clear_env = no — НЕ очищать окружение, т.е. env-переменные контейнера будут видны в PHP (getenv(), $_ENV).
; Удобно для Docker (DB_*, REDIS_*, XDEBUG_* и т.п.).
; В проде иногда включают clear_env = yes и явно перечисляют env[VAR] = ... для более строгой модели.
clear_env = no

; ------------------------------------------------------------------------------
; Управление процессами (Process Manager)
; ------------------------------------------------------------------------------

; Режим управления воркерами:
; dynamic — FPM сам поддерживает нужное число процессов между min/max spare.
; Хороший «дефолт» для большинства веб-приложений со скачкообразной нагрузкой.
pm = dynamic

; Максимальное число воркеров (детей), которые могут обслуживать запросы одновременно.
; Это главный лимит по конкурентности и памяти: каждый воркер = отдельный процесс = отдельный расход RAM.
pm.max_children = 10

; Сколько воркеров поднять сразу при старте пула.
; Слишком много — лишняя память «впустую», слишком мало — задержки на разогрев под нагрузкой.
pm.start_servers = 2

; Минимум «свободных» (idle) воркеров.
; Если свободных меньше — FPM будет форкать новые процессы.
pm.min_spare_servers = 1

; Максимум «свободных» (idle) воркеров.
; Если свободных больше — FPM будет завершать лишние процессы, освобождая память.
pm.max_spare_servers = 4

; Ограничение количества запросов на один воркер до принудительного перезапуска.
; Полезно против редких утечек/фрагментации: воркер «освежается» после N запросов.
; Слишком маленькое значение увеличит накладные расходы на частые перезапуски.
pm.max_requests = 500

; ------------------------------------------------------------------------------
; Логи и диагностика
; ------------------------------------------------------------------------------

; Перехватывать stdout/stderr воркеров и направлять в лог php-fpm.
; В контейнерах это особенно удобно: сообщения окажутся в stdout/stderr контейнера и видны через docker logs.
catch_workers_output = yes

; Таймаут «медленного» запроса.
; Если выполнение дольше указанного — FPM запишет slowlog (с backtrace), чтобы понять, где тормозит код.
request_slowlog_timeout = 5s

; Куда писать slowlog.
; /proc/self/fd/2 = stderr текущего процесса:
; - идеально для Docker/оркестраторов (логи собираются централизованно)
; - не нужно заводить отдельный файл и думать о ротации внутри контейнера
slowlog = /proc/self/fd/2

; Жёсткий таймаут выполнения запроса.
; Если запрос не завершился вовремя — FPM завершит воркер.
; Это «предохранитель», чтобы зависшие запросы не съедали все воркеры навсегда.
request_terminate_timeout = 60s

; ------------------------------------------------------------------------------
; Healthcheck
; ------------------------------------------------------------------------------

; Встроенный ping endpoint FPM.
; Используется для внутренних проверок работоспособности (например, cgi-fcgi в healthcheck контейнера).
; Важно: этот endpoint не должен быть доступен напрямую из интернета.
ping.path = /ping

; Тело ответа для ping (что вернёт FPM при успешном ответе).
ping.response = pong

; ------------------------------------------------------------------------------
; Безопасность
; ------------------------------------------------------------------------------

; Ограничение расширений файлов, которые FPM согласен исполнять.
; Защищает от случайной обработки «не-PHP» файлов через FastCGI при неверной настройке веб-сервера.
security.limit_extensions = .php